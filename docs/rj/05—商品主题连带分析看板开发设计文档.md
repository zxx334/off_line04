商品主题连带分析看板开发设计文档

一、业务分析

1.1 分析目标

    查看店内引流款/热销款TOP单品与其他商品的关联关系

    统计同时访问、同时收藏加购、同时段支付的Top30商品

    分析最近引导访客数前10的商品及其连带商品

    涉及三大核心场景：

        商品关联关系分析

        用户行为追踪

        交易转化记录

1.2 数据来源与定义

    引流款：商品详情页引导访客数排序前10

    热销款：近7天销量排序前10

    关联商品Top30：按同时访问/收藏加购/支付频次降序取前30

二、数据源说明
2.1 数据表清单（MySQL）


    表名	                           说明	                        分区

    dim_product_info	             商品基础信息表	                 无
    dwd_user_behavior_log	         用户行为日志表	                 按天
    dwd_order_transaction	         订单交易表	                     按月
    dws_product_traffic_summary	     商品流量汇总表	                 按天
    dwd_fav_cart_record	             收藏加购记录表	                 按月

三、数据仓库分层设计与实现

3.1 DIM层（维度表）

        -- 用户维度表
        CREATE TABLE dim_user (
            user_id BIGINT PRIMARY KEY,
            login_name VARCHAR(200),
            nick_name VARCHAR(200),
            user_level VARCHAR(200),
            gender VARCHAR(1),
            create_time DATETIME,
            update_time DATETIME,
            status VARCHAR(200)
        );

        -- 商品维度表
        CREATE TABLE dim_sku (
            sku_id BIGINT PRIMARY KEY,
            sku_name VARCHAR(200),
            sku_price DECIMAL(10,2),
            sku_desc VARCHAR(2000),
            brand_id BIGINT,
            brand_name VARCHAR(100),
            category3_id BIGINT,
            is_sale TINYINT,
            create_time DATETIME,
            update_time DATETIME
        );

3.2 DWD层（事实表）

        -- 用户行为事实表
    CREATE TABLE dwd_user_behavior_log (
        id BIGINT AUTO_INCREMENT,
        user_id BIGINT,
        sku_id BIGINT,
        date_key INT,
        session_id VARCHAR(100),
        behavior_type ENUM('page_view','product_click','add_cart','remove_cart','favorite','remove_favorite','purchase','search','app_start','app_exit'),
        page_type ENUM('home','product_detail','cart','category','search','favorite','order','profile'),
        refer_sku_id BIGINT,
        refer_page_type VARCHAR(50),
        during_time INT,
        cart_quantity INT,
        search_keyword VARCHAR(100),
        order_id BIGINT,
        event_time DATETIME,
        device_brand VARCHAR(50),
        channel VARCHAR(50),
        PRIMARY KEY (id, date_key)
    ) PARTITION BY RANGE (date_key) (
        PARTITION p20251015 VALUES LESS THAN (20251016),
        PARTITION p20251016 VALUES LESS THAN (20251017),
        PARTITION p20251017 VALUES LESS THAN (20251018)
    );

    -- 订单事实表
    CREATE TABLE dwd_order_detail_fact (
        id BIGINT AUTO_INCREMENT,
        date_key INT,
        user_id BIGINT,
        sku_id BIGINT,
        order_id BIGINT,
        order_status VARCHAR(20),
        sku_num BIGINT,
        order_price DECIMAL(10,2),
        total_amount DECIMAL(10,2),
        order_time DATETIME,
        create_time DATETIME,
        PRIMARY KEY (id, date_key)
    ) PARTITION BY RANGE (date_key) (
        PARTITION p20251015 VALUES LESS THAN (20251016),
        PARTITION p20251016 VALUES LESS THAN (20251017),
        PARTITION p20251017 VALUES LESS THAN (20251018)
    );

3.3 DWS层（汇总表）

    -- 商品行为日汇总表
    CREATE TABLE dws_sku_behavior_daily (
        sku_id BIGINT,
        date_key INT,
        exposure_count BIGINT,
        exposure_users BIGINT,
        click_count BIGINT,
        click_users BIGINT,
        cart_count BIGINT,
        cart_users BIGINT,
        favorite_count BIGINT,
        favorite_users BIGINT,
        order_count BIGINT,
        order_users BIGINT,
        order_quantity BIGINT,
        order_amount DECIMAL(16,2),
        guide_count BIGINT,
        guide_users BIGINT,
        PRIMARY KEY (sku_id, date_key)
    );

    -- 商品关联日汇总表
    CREATE TABLE dws_sku_association_daily (
        main_sku_id BIGINT,
        assoc_sku_id BIGINT,
        date_key INT,
        co_exposure_count BIGINT,
        co_exposure_users BIGINT,
        co_click_count BIGINT,
        co_click_users BIGINT,
        co_cart_count BIGINT,
        co_cart_users BIGINT,
        co_favorite_count BIGINT,
        co_favorite_users BIGINT,
        co_purchase_count BIGINT,
        co_purchase_users BIGINT,
        guide_count BIGINT,
        guide_users BIGINT,
        guide_conversion_count BIGINT,
        PRIMARY KEY (main_sku_id, assoc_sku_id, date_key)
    );

3.4 ADS层（应用层）


    -- 商品连带分析汇总表
    CREATE TABLE ads_sku_association_summary (
        date_key INT,
        main_sku_id BIGINT,
        main_sku_name VARCHAR(200),
        guide_user_count BIGINT,
        guide_count BIGINT,
        guide_conversion_count BIGINT,
        guide_conversion_rate DECIMAL(8,4),
        co_purchase_count BIGINT,
        co_purchase_users BIGINT,
        co_exposure_count BIGINT,
        co_click_count BIGINT,
        co_cart_count BIGINT,
        guide_rank INT,
        purchase_rank INT,
        PRIMARY KEY (date_key, main_sku_id)
    );

    -- 商品关联明细表
    CREATE TABLE ads_sku_association_detail (
        date_key INT,
        main_sku_id BIGINT,
        assoc_sku_id BIGINT,
        main_sku_name VARCHAR(200),
        assoc_sku_name VARCHAR(200),
        guide_count BIGINT,
        guide_users BIGINT,
        guide_conversion_count BIGINT,
        guide_conversion_rate DECIMAL(8,4),
        co_exposure_count BIGINT,
        co_click_count BIGINT,
        co_cart_count BIGINT,
        co_purchase_count BIGINT,
        association_strength DECIMAL(8,4),
        association_rank INT,
        PRIMARY KEY (date_key, main_sku_id, assoc_sku_id)
    );

    -- 商品类型分类表
    CREATE TABLE ads_sku_type_classification (
        date_key INT,
        sku_id BIGINT,
        sku_name VARCHAR(200),
        sku_type ENUM('guide', 'hot', 'normal'),
        guide_rank INT,
        purchase_rank INT,
        guide_user_count BIGINT,
        order_count BIGINT,
        PRIMARY KEY (date_key, sku_id)
    );


四、关键业务逻辑实现

4.1 商品关联关系计算

            WITH user_behavior_sequence AS (
            SELECT
                user_id, session_id, sku_id, date_key, event_time, behavior_type,
                LAG(sku_id) OVER (PARTITION BY user_id, session_id, date_key ORDER BY event_time) as prev_sku_id,
                LAG(event_time) OVER (PARTITION BY user_id, session_id, date_key ORDER BY event_time) as prev_event_time
            FROM dwd_user_behavior_log
            WHERE date_key BETWEEN 20251015 AND 20251017
            AND sku_id IS NOT NULL
            AND behavior_type IN ('page_view','product_click','add_cart','favorite','purchase')
        ),
        valid_sequences AS (
            SELECT 
                user_id, session_id, date_key,
                prev_sku_id as main_sku_id,
                sku_id as assoc_sku_id,
                behavior_type,
                TIMESTAMPDIFF(SECOND, prev_event_time, event_time) as time_diff_seconds
            FROM user_behavior_sequence
            WHERE prev_sku_id IS NOT NULL
            AND prev_sku_id != sku_id
            AND TIMESTAMPDIFF(SECOND, prev_event_time, event_time) BETWEEN 1 AND 1800
        )
        SELECT 
            main_sku_id, assoc_sku_id, date_key,
            COUNT(*) as guide_count,
            COUNT(DISTINCT user_id) as guide_users,
            COUNT(CASE WHEN behavior_type = 'purchase' THEN 1 END) as guide_conversion_count
        FROM valid_sequences
        GROUP BY main_sku_id, assoc_sku_id, date_key;


    4.2 商品类型分类逻辑
        INSERT INTO ads_sku_type_classification
    SELECT
        ass.date_key,
        ass.main_sku_id as sku_id,
        ass.main_sku_name as sku_name,
        CASE
            WHEN ass.guide_rank <= 10 THEN 'guide'
            WHEN dsb.order_count >= (SELECT AVG(order_count) FROM dws_sku_behavior_daily WHERE order_count > 0) THEN 'hot'
            ELSE 'normal'
        END as sku_type,
        ass.guide_rank,
        ass.purchase_rank,
        ass.guide_user_count,
        COALESCE(dsb.order_count, 0) as order_count
    FROM ads_sku_association_summary ass
    LEFT JOIN dws_sku_behavior_daily dsb ON ass.main_sku_id = dsb.sku_id AND ass.date_key = dsb.date_key;
